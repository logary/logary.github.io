<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Henrik Feldt">
        <link rel="canonical" href="https://logary.github.io/advanced/v2-refactor/">
        <link rel="shortcut icon" href="../../img/favicon.ico">

        <title>v2.0-refactor</title>

        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link href="../../css/prettify-1.0.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        
            <link href="../../../../css/fixes.css" rel="stylesheet" />
        

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
        

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <!-- Main title -->
            <a class="navbar-brand" href="../..">Logary</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav">
            
            
                <li >
                    <a href="../..">Home</a>
                </li>
            
            
            
                <li >
                    <a href="../../api/">API</a>
                </li>
            
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Targets <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../../targets/overview/">Overview</a>
                        </li>
                    
                        <li >
                            <a href="../../targets/textwriter/">TextWriter</a>
                        </li>
                    
                        <li >
                            <a href="../../targets/console/">Console</a>
                        </li>
                    
                        <li >
                            <a href="../../targets/debugger/">Debugger</a>
                        </li>
                    
                        <li >
                            <a href="../../targets/file/">File</a>
                        </li>
                    
                        <li >
                            <a href="../../targets/logstash/">Logstash</a>
                        </li>
                    
                        <li >
                            <a href="../../targets/graphite/">Graphite</a>
                        </li>
                    
                        <li >
                            <a href="../../targets/elmahio/">ElmahIO</a>
                        </li>
                    
                        <li >
                            <a href="../../targets/logentries/">Logentries</a>
                        </li>
                    
                        <li >
                            <a href="../../targets/loggr/">Loggr</a>
                        </li>
                    
                        <li >
                            <a href="../../targets/riemann/">Riemann</a>
                        </li>
                    
                        <li >
                            <a href="../../targets/db/">DB</a>
                        </li>
                    
                        <li >
                            <a href="../../targets/nimrod/">Nimrod</a>
                        </li>
                    
                        <li >
                            <a href="../../targets/dash/">Dash</a>
                        </li>
                    
                        <li >
                            <a href="../../targets/zipkin/">Zipkin</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Adapters <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../../adapters/overview/">Overview</a>
                        </li>
                    
                        <li >
                            <a href="../../adapters/eventstore/">EventStore</a>
                        </li>
                    
                        <li >
                            <a href="../../adapters/suave/">Suave</a>
                        </li>
                    
                        <li >
                            <a href="../../adapters/topshelf/">Topshelf</a>
                        </li>
                    
                        <li >
                            <a href="../../adapters/log4net/">log4net</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            
                <li class="dropdown active">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Advanced <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../overview/">Overview</a>
                        </li>
                    
                        <li class="active">
                            <a href="./">v2.0-refactor</a>
                        </li>
                    
                        <li >
                            <a href="../reservoirs/">Reservoirs</a>
                        </li>
                    
                        <li >
                            <a href="../writing-a-target/">Writing a Target</a>
                        </li>
                    
                        <li >
                            <a href="../writing-a-metric/">Writing a Metric</a>
                        </li>
                    
                        <li >
                            <a href="../thinking-about-time/">Thinking About Time</a>
                        </li>
                    
                        <li >
                            <a href="../contributing/">Contributing</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            
                <li >
                    <a href="../../about/">About</a>
                </li>
            
            
            </ul>

            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                
                <li >
                    <a rel="next" href="../overview/">
                        <i class="fa fa-arrow-left"></i> Previous
                    </a>
                </li>
                <li >
                    <a rel="prev" href="../reservoirs/">
                        Next <i class="fa fa-arrow-right"></i>
                    </a>
                </li>
                
                <li>
                    <a href="https://github.com/logary/logary/">
                        
                            <i class="fa fa-github"></i>
                        
                        GitHub
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#refactor-notes-logary-notes-impl-metrics">Refactor notes: Logary notes impl metrics</a></li>
        
            <li><a href="#step-one-primitives">Step one - primitives</a></li>
        
            <li><a href="#step-two-logary-integration">Step two - logary integration</a></li>
        
            <li><a href="#step-three-creating-custom-probes">Step three - creating custom probes</a></li>
        
            <li><a href="#step-four-documenting-the-above">Step four - documenting the above</a></li>
        
            <li><a href="#step-five-health-checks-probes">Step five - Health Checks, Probes</a></li>
        
            <li><a href="#step-six-integrate-new-f-actors">Step six - integrate new F# Actors?</a></li>
        
            <li><a href="#step-seven-using-a-dashboard">Step seven - using a dashboard</a></li>
        
    
    </ul>
</div></div>
            <div class="col-md-9" role="main">

<h1 id="refactor-notes-logary-notes-impl-metrics">Refactor notes: Logary notes impl metrics</h1>
<p>Moving towards a dashboard with full metrics, health check and log line support.</p>
<h2 id="step-one-primitives">Step one - primitives</h2>
<p>Creating the infrastructure to hoise <code>PerformanceCounter</code> and <code>/proc</code> polling
and continuous running on SQL statements into a probe.</p>
<ul>
<li>Make <em>metric</em> an actor interface like <em>probe</em></li>
<li>Make probe similar to <em>metric</em> at first</li>
<li>Create a scheduling actor that can run <code>sample</code> on the probes and metrics</li>
<li>A console text-writer target for the above sample</li>
</ul>
<h3 id="outstanding-questions">Outstanding Questions</h3>
<p>Handling of histograms as opposed to simple reservoirs of data?</p>
<h2 id="step-two-logary-integration">Step two - logary integration</h2>
<p>Tying metrics, probes, health checks together with targets (reporters) and the registry (+ scheduler).</p>
<ul>
<li>Register and unregister sampled metric in <code>Registry</code></li>
<li>Register and unregister sampled probe in <code>Registry</code></li>
<li>Register and unregister sampled health check in <code>Registry</code></li>
<li>All three above are <em>never</em> <em>sampled</em> unless:</li>
<li>Use a <code>Rule</code> to connect a metric to a target, by specifying what <em>data point</em> to use as a gauge. This just calls <em>get_value</em> on a metric above.</li>
</ul>
<h2 id="step-three-creating-custom-probes">Step three - creating custom probes</h2>
<p>When the infrastructure is in place, we can create probes that solve common problems.</p>
<ul>
<li>Proof of concept probe that uses Göran's SQL for SQL Server to continuously report metrics.</li>
</ul>
<h2 id="step-four-documenting-the-above">Step four - documenting the above</h2>
<ul>
<li>Document how metrics, probes and health checks work and how they differ</li>
<li>Document order of initialisation</li>
<li>Document how to create custom (metric|probe|health check)</li>
<li>Document CLR perf counters, finish writing most common counters</li>
</ul>
<h2 id="step-five-health-checks-probes">Step five - Health Checks, Probes</h2>
<ul>
<li>Create health check samples</li>
<li>Create probe samples and handling failing external subsystems?</li>
</ul>
<h2 id="step-six-integrate-new-f-actors">Step six - integrate new F# Actors?</h2>
<p>Colin doing work to freeze API</p>
<h2 id="step-seven-using-a-dashboard">Step seven - using a dashboard</h2>
<p>The above is useless without a nice way to report the values. Create an in-app dashboard that can be used to access the histograms, guages and timers.</p>
<p>Let's just use the Apache 2.0 licensed Metrics.Net dashboard.</p>
<p>Extend with JsonDiffPatch to avoid sending full state every time.</p>
<p>Instead of polling, open a Server-Sent Event socket and get all patches from there, continuously applying it to the in-memory rep.</p>
<p>Make sure we can report same data:</p>
<pre><code>{
  &quot;Timestamp&quot;:&quot;2014-07-26T22:54:52.6894+02:00&quot;,
  &quot;Gauges&quot;:{
      &quot;.NET Mb in all Heaps&quot;:732.27,
      &quot;.NET Time in GC&quot;:7.94,
      &quot;Contention Rate / Sec&quot;:0.00,
      &quot;Exceptions Thrown / Sec&quot;:0.00,
      &quot;Logical Threads&quot;:28.00,
      &quot;Mb in all Heaps&quot;:4.36,
      &quot;Physical Threads&quot;:25.00,
      &quot;Queue Length / sec&quot;:0.00,
      &quot;SampleMetrics.DataValue&quot;:3628800.00,
      &quot;System AvailableRAM&quot;:1245.00,
      &quot;System CPU Usage&quot;:27.55,
      &quot;System Disk Reads/sec&quot;:0.01,
      &quot;System Disk Writes/sec&quot;:0.00,
      &quot;Time in GC&quot;:0.06,
      &quot;Total Exceptions&quot;:465.00
    },
  &quot;Counters&quot;:{
      &quot;NancyFx.ActiveRequests&quot;:0,
      &quot;SampleMetrics.ConcurrentRequests&quot;:7,
      &quot;SampleMetrics.Requests&quot;:730
    },
  &quot;Meters&quot;:{
      &quot;NancyFx.Errors&quot;:{
          &quot;Count&quot;:0,
          &quot;MeanRate&quot;:0.00,
          &quot;OneMinuteRate&quot;:0.00,
          &quot;FiveMinuteRate&quot;:0.00,
          &quot;FifteenMinuteRate&quot;:0.00
        },
      &quot;SampleMetrics.Requests&quot;:{
          &quot;Count&quot;:730,
          &quot;MeanRate&quot;:3.82,
          &quot;OneMinuteRate&quot;:3.93,
          &quot;FiveMinuteRate&quot;:4.98,
          &quot;FifteenMinuteRate&quot;:5.59
        }
    },
  &quot;Histograms&quot;:{
      &quot;NancyFx.PostAndPutRequestsSize&quot;:{
          &quot;Count&quot;:0,
          &quot;LastValue&quot;:0.00,
          &quot;Min&quot;:0.00,
          &quot;Mean&quot;:0.00,
          &quot;Max&quot;:0.00,
          &quot;StdDev&quot;:0.00,
          &quot;Median&quot;:0.00,
          &quot;Percentile75&quot;:0.00,
          &quot;Percentile95&quot;:0.00,
          &quot;Percentile98&quot;:0.00,
          &quot;Percentile99&quot;:0.00,
          &quot;Percentile999&quot;:0.00,
          &quot;SampleSize&quot;:0
        },
      &quot;SampleMetrics.ResultsExample&quot;:{
          &quot;Count&quot;:730,
          &quot;LastValue&quot;:3471.00,
          &quot;Min&quot;:-4942.00,
          &quot;Mean&quot;:105.35,
          &quot;Max&quot;:4995.00,
          &quot;StdDev&quot;:2866.55,
          &quot;Median&quot;:213.00,
          &quot;Percentile75&quot;:2576.00,
          &quot;Percentile95&quot;:4530.00,
          &quot;Percentile98&quot;:4934.00,
          &quot;Percentile99&quot;:4939.00,
          &quot;Percentile999&quot;:4995.00,
          &quot;SampleSize&quot;:730
        },
      &quot;SampleModule.TestRequest.Size&quot;:{
          &quot;Count&quot;:0,
          &quot;LastValue&quot;:0.00,
          &quot;Min&quot;:0.00,
          &quot;Mean&quot;:0.00,
          &quot;Max&quot;:0.00,
          &quot;StdDev&quot;:0.00,
          &quot;Median&quot;:0.00,
          &quot;Percentile75&quot;:0.00,
          &quot;Percentile95&quot;:0.00,
          &quot;Percentile98&quot;:0.00,
          &quot;Percentile99&quot;:0.00,
          &quot;Percentile999&quot;:0.00,
          &quot;SampleSize&quot;:0
        },
      &quot;SampleModule.TestRequestSize&quot;:{
          &quot;Count&quot;:0,
          &quot;LastValue&quot;:0.00,
          &quot;Min&quot;:0.00,
          &quot;Mean&quot;:0.00,
          &quot;Max&quot;:0.00,
          &quot;StdDev&quot;:0.00,
          &quot;Median&quot;:0.00,
          &quot;Percentile75&quot;:0.00,
          &quot;Percentile95&quot;:0.00,
          &quot;Percentile98&quot;:0.00,
          &quot;Percentile99&quot;:0.00,
          &quot;Percentile999&quot;:0.00,
          &quot;SampleSize&quot;:0
        }
    },
  &quot;Timers&quot;:{
      &quot;NancyFx.GET [/metrics/health]&quot;:{
          &quot;Rate&quot;:{
              &quot;Count&quot;:36,
              &quot;MeanRate&quot;:0.19,
              &quot;OneMinuteRate&quot;:0.21,
              &quot;FiveMinuteRate&quot;:0.20,
              &quot;FifteenMinuteRate&quot;:0.20
            },
          &quot;Histogram&quot;:{
              &quot;Count&quot;:36,
              &quot;LastValue&quot;:425.69,
              &quot;Min&quot;:330.85,
              &quot;Mean&quot;:382.34,
              &quot;Max&quot;:435.18,
              &quot;StdDev&quot;:26.54,
              &quot;Median&quot;:381.06,
              &quot;Percentile75&quot;:403.76,
              &quot;Percentile95&quot;:427.11,
              &quot;Percentile98&quot;:435.18,
              &quot;Percentile99&quot;:435.18,
              &quot;Percentile999&quot;:435.18,
              &quot;SampleSize&quot;:36
            }
        },
      &quot;NancyFx.GET [/metrics/json]&quot;:{
          &quot;Rate&quot;:{
              &quot;Count&quot;:732,
              &quot;MeanRate&quot;:3.94,
              &quot;OneMinuteRate&quot;:4.32,
              &quot;FiveMinuteRate&quot;:2.44,
              &quot;FifteenMinuteRate&quot;:1.56
            },
          &quot;Histogram&quot;:{
              &quot;Count&quot;:732,
              &quot;LastValue&quot;:3.79,
              &quot;Min&quot;:2.31,
              &quot;Mean&quot;:7.55,
              &quot;Max&quot;:408.84,
              &quot;StdDev&quot;:19.57,
              &quot;Median&quot;:3.31,
              &quot;Percentile75&quot;:3.92,
              &quot;Percentile95&quot;:39.78,
              &quot;Percentile98&quot;:61.07,
              &quot;Percentile99&quot;:71.70,
              &quot;Percentile999&quot;:408.84,
              &quot;SampleSize&quot;:732
            }
        },
      &quot;NancyFx.GET [/metrics]&quot;:{
          &quot;Rate&quot;:{
              &quot;Count&quot;:3,
              &quot;MeanRate&quot;:0.02,
              &quot;OneMinuteRate&quot;:0.02,
              &quot;FiveMinuteRate&quot;:0.11,
              &quot;FifteenMinuteRate&quot;:0.16
            },
          &quot;Histogram&quot;:{
              &quot;Count&quot;:3,
              &quot;LastValue&quot;:0.13,
              &quot;Min&quot;:0.13,
              &quot;Mean&quot;:26.05,
              &quot;Max&quot;:77.86,
              &quot;StdDev&quot;:44.87,
              &quot;Median&quot;:0.16,
              &quot;Percentile75&quot;:77.86,
              &quot;Percentile95&quot;:77.86,
              &quot;Percentile98&quot;:77.86,
              &quot;Percentile99&quot;:77.86,
              &quot;Percentile999&quot;:77.86,
              &quot;SampleSize&quot;:3
            }
        },
      &quot;NancyFx.Requests&quot;:{
          &quot;Rate&quot;:{
              &quot;Count&quot;:771,
              &quot;MeanRate&quot;:4.03,
              &quot;OneMinuteRate&quot;:4.56,
              &quot;FiveMinuteRate&quot;:2.11,
              &quot;FifteenMinuteRate&quot;:0.95
            },
          &quot;Histogram&quot;:{
              &quot;Count&quot;:771,
              &quot;LastValue&quot;:3.78,
              &quot;Min&quot;:0.11,
              &quot;Mean&quot;:25.10,
              &quot;Max&quot;:435.15,
              &quot;StdDev&quot;:81.60,
              &quot;Median&quot;:3.33,
              &quot;Percentile75&quot;:4.15,
              &quot;Percentile95&quot;:79.62,
              &quot;Percentile98&quot;:388.93,
              &quot;Percentile99&quot;:408.69,
              &quot;Percentile999&quot;:435.15,
              &quot;SampleSize&quot;:771
            }
        },
      &quot;SampleMetrics.Requests&quot;:{
          &quot;Rate&quot;:{
              &quot;Count&quot;:723,
              &quot;MeanRate&quot;:3.78,
              &quot;OneMinuteRate&quot;:3.83,
              &quot;FiveMinuteRate&quot;:4.64,
              &quot;FifteenMinuteRate&quot;:5.09
            },
          &quot;Histogram&quot;:{
              &quot;Count&quot;:723,
              &quot;LastValue&quot;:472.59,
              &quot;Min&quot;:10.99,
              &quot;Mean&quot;:1393.96,
              &quot;Max&quot;:2998.03,
              &quot;StdDev&quot;:875.90,
              &quot;Median&quot;:1282.13,
              &quot;Percentile75&quot;:2145.02,
              &quot;Percentile95&quot;:2892.10,
              &quot;Percentile98&quot;:2949.10,
              &quot;Percentile99&quot;:2994.81,
              &quot;Percentile999&quot;:2998.03,
              &quot;SampleSize&quot;:217
            }
        },
      &quot;SampleModule.TestRequest.Time&quot;:{
          &quot;Rate&quot;:{
              &quot;Count&quot;:0,
              &quot;MeanRate&quot;:0.00,
              &quot;OneMinuteRate&quot;:0.00,
              &quot;FiveMinuteRate&quot;:0.00,
              &quot;FifteenMinuteRate&quot;:0.00
            },
          &quot;Histogram&quot;:{
              &quot;Count&quot;:0,
              &quot;LastValue&quot;:0.00,
              &quot;Min&quot;:0.00,
              &quot;Mean&quot;:0.00,
              &quot;Max&quot;:0.00,
              &quot;StdDev&quot;:0.00,
              &quot;Median&quot;:0.00,
              &quot;Percentile75&quot;:0.00,
              &quot;Percentile95&quot;:0.00,
              &quot;Percentile98&quot;:0.00,
              &quot;Percentile99&quot;:0.00,
              &quot;Percentile999&quot;:0.00,
              &quot;SampleSize&quot;:0
            }
        }
    },
  &quot;Units&quot;:{
      &quot;Gauges&quot;:{
          &quot;.NET Mb in all Heaps&quot;:&quot;Mb&quot;,
          &quot;.NET Time in GC&quot;:&quot;%&quot;,
          &quot;Contention Rate / Sec&quot;:&quot;Attempts/s&quot;,
          &quot;Exceptions Thrown / Sec&quot;:&quot;Exceptions/s&quot;,
          &quot;Logical Threads&quot;:&quot;Threads&quot;,
          &quot;Mb in all Heaps&quot;:&quot;Mb&quot;,
          &quot;Physical Threads&quot;:&quot;Threads&quot;,
          &quot;Queue Length / sec&quot;:&quot;Threads/s&quot;,
          &quot;SampleMetrics.DataValue&quot;:&quot;$&quot;,
          &quot;System AvailableRAM&quot;:&quot;Mb&quot;,
          &quot;System CPU Usage&quot;:&quot;%&quot;,
          &quot;System Disk Reads/sec&quot;:&quot;kb/s&quot;,
          &quot;System Disk Writes/sec&quot;:&quot;kb/s&quot;,
          &quot;Time in GC&quot;:&quot;%&quot;,
          &quot;Total Exceptions&quot;:&quot;Exceptions&quot;
        },
      &quot;Counters&quot;:{
          &quot;NancyFx.ActiveRequests&quot;:&quot;ActiveRequests&quot;,
          &quot;SampleMetrics.ConcurrentRequests&quot;:&quot;Requests&quot;,
          &quot;SampleMetrics.Requests&quot;:&quot;Requests&quot;
        },
      &quot;Meters&quot;:{
          &quot;NancyFx.Errors&quot;:&quot;Errors/s&quot;,
          &quot;SampleMetrics.Requests&quot;:&quot;Requests/s&quot;
        },
      &quot;Histograms&quot;:{
          &quot;NancyFx.PostAndPutRequestsSize&quot;:&quot;bytes&quot;,
          &quot;SampleMetrics.ResultsExample&quot;:&quot;Items&quot;,
          &quot;SampleModule.TestRequest.Size&quot;:&quot;bytes&quot;,
          &quot;SampleModule.TestRequestSize&quot;:&quot;bytes&quot;
        },
      &quot;Timers&quot;:{
          &quot;NancyFx.GET [/metrics/health]&quot;:{
              &quot;Rate&quot;:&quot;Requests/s&quot;,
              &quot;Duration&quot;:&quot;ms&quot;
            },
          &quot;NancyFx.GET [/metrics/json]&quot;:{
              &quot;Rate&quot;:&quot;Requests/s&quot;,
              &quot;Duration&quot;:&quot;ms&quot;
            },
          &quot;NancyFx.GET [/metrics]&quot;:{
              &quot;Rate&quot;:&quot;Requests/s&quot;,
              &quot;Duration&quot;:&quot;ms&quot;
            },
          &quot;NancyFx.Requests&quot;:{
              &quot;Rate&quot;:&quot;Requests/s&quot;,
              &quot;Duration&quot;:&quot;ms&quot;
            },
          &quot;SampleMetrics.Requests&quot;:{
              &quot;Rate&quot;:&quot;Requests/s&quot;,
              &quot;Duration&quot;:&quot;ms&quot;
            },
          &quot;SampleModule.TestRequest.Time&quot;:{
              &quot;Rate&quot;:&quot;Requests/s&quot;,
              &quot;Duration&quot;:&quot;ms&quot;
            }
        }
    }
}
</code></pre></div>
        </div>

        

        <script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/prettify-1.0.min.js"></script>
        <script src="../../js/base.js"></script>
    </body>
</html>